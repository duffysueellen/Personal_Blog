{
  "hash": "f8246a857e1d9d42f530be8ad7febe51",
  "result": {
    "markdown": "---\ntitle: \"Network Block Modeling - Patients\"\nauthor: \"Sue-Ellen Duffy\"\ndate: \"2024-05-03\"\ncategories: [code, analysis, block_model]\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(readr)\nlibrary(igraph)\nlibrary(sna)\nlibrary(intergraph)\nlibrary(ggplot2)\n```\n:::\n\n\nThis post will explore the Synthetic Mass network data in more detail.\n\n# Read in Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\npat_attr <- read_csv(\"post1drug_data/pat_attr.csv\", \n    col_types = cols(...1 = col_skip()))\npro_attr <- read_csv(\"post1drug_data/pro_attr.csv\", \n    col_types = cols(...1 = col_skip()))\nencounters_cleaning <- read_csv(\"post1drug_data//encounters_cleaning.csv\", \n    col_types = cols(...1 = col_skip()))\nencounters_cleaned <- read_csv(\"post1drug_data//encounters_cleaned.csv\", \n    col_types = cols(...1 = col_skip()))\nencounter_attributes <- read_csv(\"post1drug_data/encounter_attributes.csv\", \n    col_types = cols(...1 = col_skip()))\nencounters_el  <- read_csv(\"post1drug_data/encounters_el.csv\", \n    col_types = cols(...1 = col_skip()))\nencounters_st_3 <- read_csv(\"post1drug_data/encounters.st.3.csv\", \n    col_types = cols(...1 = col_skip()))\nattribute_list <- read.csv(\"post1drug_data/attribute_list.csv\")\n```\n:::\n\n\n# Create bipartite network with attributes\n\n\n::: {.cell}\n\n```{.r .cell-code}\nencounters.stat <- network(encounters_el,\n                         directed = FALSE,\n                         bipartite = TRUE,\n                         matrix.type = \"edgelist\",\n                         vertex.attr = attribute_list)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#create igraph\nencounters.ig <- graph_from_biadjacency_matrix(encounters.stat)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nencounters.stat2 <- asNetwork(encounters.ig)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nprojected_graph <- bipartite_projection(encounters.ig)\npatient_matrix <- as.matrix(as_adjacency_matrix(projected_graph$proj1))\n\npatient.stat <- asNetwork(projected_graph$proj1)\n\npatient.se <- equiv.clust(patient_matrix,\n equiv.fun = \"sedist\",\n method = \"hamming\",\n mode = \"graph\",\n cluster.method = \"complete\")\n\nnames(patient.se)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"cluster\"        \"metric\"         \"equiv.fun\"      \"cluster.method\"\n[5] \"glabels\"        \"plabels\"       \n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(patient.se, main = \"patient\")\nrect.hclust(patient.se$cluster, k = 6)\n```\n\n::: {.cell-output-display}\n![](post_3_drug_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npat_blk_model.patient.org <- blockmodel(patient_matrix,\n patient.se, k = 6)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n pat_blk_model.patient.org$block.model\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n            Block 1    Block 2   Block 3     Block 4   Block 5 Block 6\nBlock 1 0.019557823 0.02678571 0.0127551 0.006802721 0.0000000       0\nBlock 2 0.026785714 1.00000000 0.0000000 0.010416667 0.1458333       1\nBlock 3 0.012755102 0.00000000 1.0000000 0.000000000 0.0625000       1\nBlock 4 0.006802721 0.01041667 0.0000000 1.000000000 0.0000000       0\nBlock 5 0.000000000 0.14583333 0.0625000 0.000000000 0.6000000       0\nBlock 6 0.000000000 1.00000000 1.0000000 0.000000000 0.0000000     NaN\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot.block<-function(x=pat_blk_mod, main=NULL, cex.lab=.00001,show_labels = FALSE){\n plot.sociomatrix(x$blocked.data, labels=list(x$plabels,x$plabels),\n main=main, drawlines = FALSE, cex.lab=cex.lab)\n for (j in 2:length(x$plabels)) if (x$block.membership[j] !=\n x$block.membership[j-1])\n abline(v = j- 0.5, h = j- 0.5, lty = 3, xpd=FALSE)\n }\n \nplot.block(pat_blk_model.patient.org, main = \"patient\")\n```\n\n::: {.cell-output-display}\n![](post_3_drug_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#pat_blks6 <- blockmodeling::optRandomParC(patient_matrix,k=6, rep=20, approaches=\"ss\", blocks=\"com\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Save the blks2 object to a file\n#saveRDS(pat_blks6, \"pat_blks6_results.rds\")\n\n# Later, when you want to use it again, you can read it back into R\npat_blks6 <- readRDS(\"pat_blks6_results.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# blockmodel with optimized partition\npat_blk_mod <- blockmodel(patient_matrix, pat_blks6$best$best1$clu,\n                      plabels = rownames(patient_matrix))\n# print blockmodel object\npat_blk_mod$block.model\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n        Block 1    Block 2    Block 3     Block 4    Block 5     Block 6\nBlock 1       1 1.00000000 0.00000000 0.000000000 1.00000000 0.000000000\nBlock 2       1 0.70000000 0.05000000 0.000000000 0.05333333 0.008000000\nBlock 3       0 0.05000000 1.00000000 0.000000000 0.06666667 0.015000000\nBlock 4       0 0.00000000 0.00000000 1.000000000 0.01111111 0.006666667\nBlock 5       1 0.05333333 0.06666667 0.011111111 1.00000000 0.028000000\nBlock 6       0 0.00800000 0.01500000 0.006666667 0.02800000 0.018775510\n```\n:::\n:::\n\n\n#assign attributes\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(pat_blk_mod)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nList of 11\n $ block.membership: int [1:86] 1 1 2 2 2 2 2 3 3 3 ...\n $ order.vector    : int [1:86] 31 67 19 28 63 75 85 8 9 10 ...\n $ block.content   : chr \"density\"\n $ blocked.data    : num [1:86, 1:86] 0 1 1 1 1 1 1 0 0 0 ...\n  ..- attr(*, \"dimnames\")=List of 2\n  .. ..$ : chr [1:86] \"Johnnie679 Hand679\" \"Rudy520 Hettinger594\" \"Dortha70 Rutherford999\" \"Ivan258 Hills818\" ...\n  .. ..$ : chr [1:86] \"Johnnie679 Hand679\" \"Rudy520 Hettinger594\" \"Dortha70 Rutherford999\" \"Ivan258 Hills818\" ...\n $ block.model     : num [1:6, 1:6] 1 1 0 0 1 0 1 0.7 0.05 0 ...\n  ..- attr(*, \"dimnames\")=List of 2\n  .. ..$ : chr [1:6] \"Block 1\" \"Block 2\" \"Block 3\" \"Block 4\" ...\n  .. ..$ : chr [1:6] \"Block 1\" \"Block 2\" \"Block 3\" \"Block 4\" ...\n $ plabels         : chr [1:86] \"Johnnie679 Hand679\" \"Rudy520 Hettinger594\" \"Dortha70 Rutherford999\" \"Ivan258 Hills818\" ...\n $ glabels         : int [1:86] 1 2 3 4 5 6 7 8 9 10 ...\n $ rlabels         : chr [1:6] \"Block 1\" \"Block 2\" \"Block 3\" \"Block 4\" ...\n $ cluster.method  : chr \"Prespecified\"\n $ equiv.fun       : chr \"None\"\n $ equiv.metric    : chr \"None\"\n - attr(*, \"class\")= chr \"blockmodel\"\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npat_attr$block <- pat_blk_mod$block.membership\nhead(pat_attr)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 9\n  NAME                   GENDER RACE  MARITAL  CITY     INCOME   AGE type  block\n  <chr>                  <chr>  <chr> <chr>    <chr>     <dbl> <dbl> <chr> <int>\n1 Annice210 Gleason633   Female white Married  brookli…   1565    37 PATI…     1\n2 Julianne852 Barrows492 Female white Widowed  hamilton  39537    65 PATI…     1\n3 Alesha810 Heaney114    Female white Divorced framing… 114339    46 PATI…     2\n4 Sandee884 Rice937      Female white <NA>     taunton   96256    26 PATI…     2\n5 Mia349 Runte676        Female white Divorced chelmsf…  71238    44 PATI…     2\n6 Damian46 Dach178       Male   white <NA>     swansea   74155    26 PATI…     2\n```\n:::\n\n```{.r .cell-code}\n#write.csv(pat_attr, \"pat_attr.csv\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot.block(pat_blk_mod, main = \"patient\",\n           cex.lab = .000001)\n```\n\n::: {.cell-output-display}\n![](post_3_drug_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#assign block membership to vertex attribute\npatient.stat%v%\"role\"<-pat_blk_mod$block.membership[match(patient.stat%v%\"vertex.names\",pat_blk_mod$plabels)]\n#plot network using \"role\" to color nodes\nGGally::ggnet2(patient.stat,\n               node.color=\"role\", \n               node.size=sna::degree(patient.stat, gmode=\"graph\"),\n               node.alpha = .5)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nRegistered S3 method overwritten by 'GGally':\n  method from   \n  +.gg   ggplot2\n```\n:::\n\n::: {.cell-output-display}\n![](post_3_drug_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ade4)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: package 'ade4' was built under R version 4.3.3\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nencounters.adj.ig <- igraph::as_biadjacency_matrix(encounters.ig)\n\npatients_jaccard <- dist.binary(encounters.adj.ig,\n            method = 1, # method=1 Jaccard index\n            upper = TRUE,\n            diag = FALSE)\n\npatients_jaccard <- as.matrix(patients_jaccard)\ndiag(patients_jaccard) <- 0\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#binarize\npatients_jaccard_bi <- ifelse(patients_jaccard > 0.99, 1, 0)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#create igraph object\npatients_jaccard.ig <- graph_from_adjacency_matrix(patients_jaccard_bi, mode = \"undirected\")\nsummary(patients_jaccard.ig)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nIGRAPH eba9662 UN-- 86 3390 -- \n+ attr: name (v/c)\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(patients_jaccard.ig,  edge.width = 0.0002, edge.color = \"lightgray\",  vertex.size = 2, vertex.label = NA)\n```\n\n::: {.cell-output-display}\n![](post_3_drug_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load the igraph package\nlibrary(igraph)\n\n# Create an igraph object from the blockmodel\ng <- graph_from_adjacency_matrix(patient_matrix, mode = \"undirected\", weighted = FALSE)\n\n# Plot the graph without labels\nplot(g,      \n     layout = layout.fruchterman.reingold, \n     vertex.label.dist = 2, \n     vertex.size = 2, \n     edge.label = NA,\n     vertex.label = NA,\n     vertex.label.cex = 0.2, \n     main = \"Patient Network\")\n```\n\n::: {.cell-output-display}\n![](post_3_drug_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "post_3_drug_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}